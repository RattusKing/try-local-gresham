rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }

    function isBusinessOwner() {
      return isSignedIn() && getUserRole() == 'business_owner';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      // Admins can read all profiles
      allow read: if isOwner(userId) || isAdmin();

      // Users can create their own profile during signup
      allow create: if isSignedIn() && isOwner(userId);

      // Users can update their own profile
      // Admins can update any profile
      allow update: if isOwner(userId) || isAdmin();

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // Businesses collection
    match /businesses/{businessId} {
      // Everyone can read approved businesses
      allow read: if resource.data.status == 'approved' || isAdmin() ||
                     (isBusinessOwner() && resource.data.ownerId == request.auth.uid);

      // Business owners can create their own business (requires admin approval)
      // Admins can create businesses for others (during approval process)
      allow create: if (isBusinessOwner() &&
                       request.resource.data.ownerId == request.auth.uid &&
                       request.resource.data.status == 'pending') ||
                       isAdmin();

      // Business owners can update their own business BUT cannot change approval status
      // Admins can update any business (including approval status)
      allow update: if isAdmin() ||
                       (isBusinessOwner() &&
                        resource.data.ownerId == request.auth.uid &&
                        request.resource.data.status == resource.data.status);

      // Only admins can delete businesses
      allow delete: if isAdmin();
    }

    // Orders collection
    match /orders/{orderId} {
      // Customers can read their own orders
      // Business owners can read orders for their business (businessId matches their uid)
      // Admins can read all orders
      allow read: if isSignedIn() &&
                     (resource.data.userId == request.auth.uid ||
                      resource.data.businessId == request.auth.uid ||
                      isAdmin());

      // Customers can create orders
      allow create: if isSignedIn() &&
                       request.resource.data.userId == request.auth.uid;

      // Customers can update their own orders (for cancellation)
      // Business owners can update orders for their business (status updates)
      // Admins can update any order
      allow update: if isSignedIn() &&
                       (resource.data.userId == request.auth.uid ||
                        resource.data.businessId == request.auth.uid ||
                        isAdmin());

      // Only admins can delete orders
      allow delete: if isAdmin();
    }

    // Reviews collection
    match /reviews/{reviewId} {
      // Everyone can read approved reviews
      allow read: if true;

      // Signed-in users can create reviews
      allow create: if isSignedIn() &&
                       request.resource.data.userId == request.auth.uid;

      // Users can update their own reviews
      // Admins can update any review
      allow update: if (isSignedIn() && resource.data.userId == request.auth.uid) ||
                       isAdmin();

      // Users can delete their own reviews
      // Admins can delete any review
      allow delete: if (isSignedIn() && resource.data.userId == request.auth.uid) ||
                       isAdmin();
    }

    // Products collection
    match /products/{productId} {
      // Everyone can read in-stock products
      // Business owners can read their own products (including out of stock)
      allow read: if resource.data.inStock == true ||
                     (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                     isAdmin();

      // Business owners can create products for their own business
      allow create: if isBusinessOwner() &&
                       request.resource.data.businessId == request.auth.uid;

      // Business owners can update their own products
      // Admins can update any product
      allow update: if (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                       isAdmin();

      // Business owners can delete their own products
      // Admins can delete any product
      allow delete: if (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                       isAdmin();
    }

    // Business Applications collection
    match /business_applications/{applicationId} {
      // Only authenticated users can create an application
      allow create: if isSignedIn();

      // Only admins can read/update/delete applications
      allow read, update, delete: if isAdmin();
    }

    // Discount Codes collection
    match /discountCodes/{discountId} {
      // Signed-in users can read active discount codes (for checkout validation)
      // Business owners can read their own discount codes
      // Admins can read all discount codes
      allow read: if isSignedIn() &&
                     (resource.data.isActive == true ||
                      (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                      isAdmin());

      // Business owners can create discount codes for their own business
      allow create: if isBusinessOwner() &&
                       request.resource.data.businessId == request.auth.uid;

      // Business owners can update their own discount codes
      // Admins can update any discount code
      allow update: if (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                       isAdmin();

      // Business owners can delete their own discount codes
      // Admins can delete any discount code
      allow delete: if (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                       isAdmin();
    }

    // Promotional Banners collection
    match /promoBanners/{bannerId} {
      // Anyone can read active banners (for display on site)
      allow read: if true;

      // Only admins can create, update, or delete banners
      allow create, update, delete: if isAdmin();
    }

    // Sponsored Banners collection (Paid Business Promotions)
    match /sponsoredBanners/{bannerId} {
      // Anyone can read active sponsored banners (for carousel display)
      // Business owners can read their own banners
      // Admins can read all banners
      allow read: if resource.data.status == 'active' ||
                     (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                     isAdmin();

      // Business owners can create sponsored banner requests for their own business
      allow create: if isBusinessOwner() &&
                       request.resource.data.businessId == request.auth.uid &&
                       request.resource.data.status == 'pending';

      // Business owners can update their own pending banners (cancel, update headline)
      // Admins can update any banner (approve, reject, etc.)
      allow update: if isAdmin() ||
                       (isBusinessOwner() &&
                        resource.data.businessId == request.auth.uid &&
                        resource.data.status == 'pending');

      // Only admins can delete sponsored banners
      allow delete: if isAdmin();
    }

    // Favorites collection
    match /favorites/{favoriteId} {
      // Users can read their own favorites
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Users can create their own favorites
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Users can delete their own favorites
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;

      // No updates needed (favorites are add/remove only)
      allow update: if false;
    }

    // Services collection (for appointment scheduling)
    match /services/{serviceId} {
      // Everyone can read active services
      // Business owners can read their own services (including inactive)
      allow read: if resource.data.isActive == true ||
                     (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                     isAdmin();

      // Business owners can create services for their own business
      allow create: if isBusinessOwner() &&
                       request.resource.data.businessId == request.auth.uid;

      // Business owners can update their own services
      // Admins can update any service
      allow update: if (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                       isAdmin();

      // Business owners can delete their own services
      // Admins can delete any service
      allow delete: if (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                       isAdmin();
    }

    // Business Availability collection (for appointment scheduling)
    match /businessAvailability/{availabilityId} {
      // Everyone can read business availability (to see available time slots)
      allow read: if true;

      // Business owners can create availability for their own business
      allow create: if isBusinessOwner() &&
                       request.resource.data.businessId == request.auth.uid;

      // Business owners can update their own availability
      // Admins can update any availability
      allow update: if (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                       isAdmin();

      // Business owners can delete their own availability
      // Admins can delete any availability
      allow delete: if (isBusinessOwner() && resource.data.businessId == request.auth.uid) ||
                       isAdmin();
    }

    // Appointments collection
    match /appointments/{appointmentId} {
      // Customers can read their own appointments
      // Business owners can read appointments for their business
      // Admins can read all appointments
      allow read: if isSignedIn() &&
                     (resource.data.customerId == request.auth.uid ||
                      resource.data.businessId == request.auth.uid ||
                      isAdmin());

      // Customers can create appointments (must be signed in)
      allow create: if isSignedIn() &&
                       request.resource.data.customerId == request.auth.uid;

      // Customers can update their own appointments (for cancellation, notes)
      // Business owners can update appointments for their business (status, notes)
      // Admins can update any appointment
      allow update: if isSignedIn() &&
                       (resource.data.customerId == request.auth.uid ||
                        resource.data.businessId == request.auth.uid ||
                        isAdmin());

      // Customers can cancel (delete) their own appointments
      // Business owners can delete appointments for their business
      // Admins can delete any appointment
      allow delete: if isSignedIn() &&
                       (resource.data.customerId == request.auth.uid ||
                        resource.data.businessId == request.auth.uid ||
                        isAdmin());
    }

    // Block all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
